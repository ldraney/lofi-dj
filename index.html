<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Overlay - Lofi Controller</title>
  <script src="https://unpkg.com/tone"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <div id="visual-container"></div>

    <div id="controls">
      <button id="btn-load-song" class="btn-secondary">Load Song</button>
      <button id="btn-load-visual" class="btn-secondary">Load Visual</button>
      <button id="btn-play" class="btn-primary">Play</button>
      <button id="btn-pause" class="btn-outline">Pause</button>
      <button id="btn-stop" class="btn-outline">Stop</button>
    </div>

    <div id="status">
      <span class="status-item">
        <span class="label">Deck:</span>
        <span class="value" id="status-deck">A</span>
      </span>
      <span class="status-item">
        <span class="label">Song:</span>
        <span class="value" id="status-song">-</span>
      </span>
      <span class="status-item">
        <span class="label">Section:</span>
        <span class="value" id="status-section">-</span>
      </span>
      <span class="status-item">
        <span class="label">Playing:</span>
        <span class="value" id="status-playing">No</span>
      </span>
    </div>
  </div>

  <script type="module">
    import { DJController } from './src/controller.js';
    import { bus } from './src/event-bus.js';

    // Initialize controller
    const controller = new DJController();
    const visualContainer = document.getElementById('visual-container');

    // Status elements
    const statusDeck = document.getElementById('status-deck');
    const statusSong = document.getElementById('status-song');
    const statusSection = document.getElementById('status-section');
    const statusPlaying = document.getElementById('status-playing');

    // Load config
    let config = {
      defaults: { song: null, visual: null, autoPlay: false },
      display: { showControls: true, showStatus: true }
    };

    try {
      const response = await fetch('./config.json');
      if (response.ok) {
        config = await response.json();
        console.log('[DJ] Config loaded:', config);
      }
    } catch (e) {
      console.log('[DJ] No config.json found, using defaults');
    }

    // Apply display settings
    if (!config.display?.showControls) {
      document.getElementById('controls').style.display = 'none';
    }
    if (!config.display?.showStatus) {
      document.getElementById('status').style.display = 'none';
    }

    // Initialize on page load
    async function init() {
      await controller.init(visualContainer);
      console.log('[DJ] Controller initialized');

      // Auto-load defaults from config
      if (config.defaults?.song) {
        try {
          await controller.loadSong(config.defaults.song, 'A');
          statusSong.textContent = config.defaults.song.split('/').filter(Boolean)[0];
          console.log('[DJ] Auto-loaded song:', config.defaults.song);
        } catch (e) {
          console.error('[DJ] Failed to auto-load song:', e);
        }
      }

      if (config.defaults?.visual) {
        try {
          await controller.loadVisual(config.defaults.visual, 0);
          console.log('[DJ] Auto-loaded visual:', config.defaults.visual);
        } catch (e) {
          console.error('[DJ] Failed to auto-load visual:', e);
        }
      }

      // Auto-play if configured
      if (config.defaults?.autoPlay && config.defaults?.song) {
        await controller.play();
        console.log('[DJ] Auto-play started');
      }
    }

    // Event listeners for status updates
    bus.on('songLoaded', ({ deck, song }) => {
      if (deck === controller.activeDeck) {
        statusSong.textContent = song;
      }
    });

    bus.on('sectionChange', ({ section }) => {
      statusSection.textContent = section;
    });

    bus.on('play', () => {
      statusPlaying.textContent = 'Yes';
    });

    bus.on('pause', () => {
      statusPlaying.textContent = 'Paused';
    });

    bus.on('stop', () => {
      statusPlaying.textContent = 'No';
      statusSection.textContent = '-';
    });

    // Button handlers
    document.getElementById('btn-load-song').onclick = async () => {
      try {
        await controller.loadSong('/lofi-demo-song/index.js', 'A');
        statusSong.textContent = 'demo-song';
      } catch (e) {
        console.error('Failed to load song:', e);
        alert('Failed to load song. Make sure lofi-demo-song exists.');
      }
    };

    document.getElementById('btn-load-visual').onclick = async () => {
      try {
        await controller.loadVisual('/visual-waveform/index.js', 0);
      } catch (e) {
        console.error('Failed to load visual:', e);
        alert('Failed to load visual. Make sure visual-waveform exists.');
      }
    };

    document.getElementById('btn-play').onclick = async () => {
      if (!controller.deckA && !controller.deckB) {
        alert('Load a song first!');
        return;
      }
      await controller.play();
    };

    document.getElementById('btn-pause').onclick = () => {
      controller.pause();
    };

    document.getElementById('btn-stop').onclick = () => {
      controller.stop();
    };

    // Initialize
    init();
  </script>
</body>
</html>
